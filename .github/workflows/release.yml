name: Publish to pub.dev

on:
  push:
    tags:
      - 'sqlite3-[0-9]+.[0-9]+.[0-9]+*'

jobs:
  #fetch_sqlite:
  #  uses: ./.github/workflows/compile_sqlite.yml

  prepare_release:
    #needs: [fetch_sqlite]
    permissions:
      packages: write
      contents: write
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - uses: dart-lang/setup-dart@v1
      with:
        sdk: beta
    - name: Pub get
      run: dart pub get
    - name: Download compiled sqlite3
      uses: actions/download-artifact@v5
      with:
        #artifact-ids: ${{ needs.fetch_sqlite.outputs.artifact_id }}
        # TODO: Ideally we'd use the artifacts compiled in this run. That should work once this has been merged to
        # the default branch, but it's unstable at the moment. fetch_sqlite will always re-compile on this branch
        # because caches from non-default branches aren't visible to runs on tags.
        # On windows, the sqlite3 build is not reproducible. So to avoid a hash mismatch, we temporarily use artifacts
        # built for a test run for releases as well.
        artifact-ids: "4333315590"
        repository: simolus3/sqlite3.dart
        run-id: "18697403389"
        github-token: ${{ github.token }}
        path: sqlite/out
    - name: Set tag name
      id: tag
      run: |
        tag=$(basename "${{ github.ref }}")
        echo "tag=$tag" >> $GITHUB_OUTPUT

    - name: Verify asset hashes
      run: dart run tool/write_asset_hashes.dart "${{ steps.tag.outputs.tag }}"
    - name: List libraries
      run: ls -al sqlite/out

    - name: Create Release
      env:
        GH_TOKEN: ${{ github.token }}
        GH_REPO: ${{ github.repository }}
      run: |
        tag="${{ steps.tag.outputs.tag }}"
        body="Pending release for $tag"
        gh release create --draft "$tag" --title "$tag" --notes "$body"

        gh release upload "$tag" sqlite/out/*

  publish:
    needs: [prepare_release]
    permissions:
      id-token: write
    uses: dart-lang/setup-dart/.github/workflows/publish.yml@v1
    with:
      environment: 'pub.dev'
      working-directory: sqlite3/
